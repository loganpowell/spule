

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      commands/FLIP.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      spule docs
    </h3>

    
      <h3>
        Resources
      </h3>
      
        <a href="http://thi.ng/umbrella">@thi.ng/umbrella</a>
      
    

    <h3>Modules</h3><ul><li id="INJECT_HEAD-nav"><a href="module-INJECT_HEAD.html">INJECT_HEAD</a></li><li id="Registration-nav"><a href="module-Registration.html">Registration</a><ul class='methods'><li data-type="method" id="Registration-registerCMD-nav"><a href="module-Registration.html#~registerCMD">registerCMD</a></li><li data-type="method" id="Registration-registerRouterDOM-nav"><a href="module-Registration.html#.registerRouterDOM">registerRouterDOM</a></li><li data-type="method" id="Registration-boot-nav"><a href="module-Registration.html#.boot">boot</a></li></ul></li><li id="Routing-nav"><a href="module-Routing.html">Routing</a><ul class='methods'><li data-type="method" id="Routing-HURLer-nav"><a href="module-Routing.html#.HURLer">HURLer</a></li><li data-type="method" id="Routing-URL__ROUTE-nav"><a href="module-Routing.html#.URL__ROUTE">URL__ROUTE</a></li><li data-type="method" id="Routing-URL_DOM__ROUTE-nav"><a href="module-Routing.html#.URL_DOM__ROUTE">URL_DOM__ROUTE</a></li></ul></li><li id="SET_STATE-nav"><a href="module-SET_STATE.html">SET_STATE</a><ul class='methods'><li data-type="method" id="SET_STATE-createSetStateCMD-nav"><a href="module-SET_STATE.html#.createSetStateCMD">createSetStateCMD</a></li></ul></li><li id="FLIP-nav"><a href="module-FLIP.html">FLIP</a></li><li id="multiplex-nav"><a href="module-multiplex.html">multiplex</a><ul class='methods'><li data-type="method" id="multiplex-multiplex-nav"><a href="module-multiplex.html#.multiplex">multiplex</a></li></ul></li><li id="streams-nav"><a href="module-streams.html">streams</a></li><li id="set$$tate-nav"><a href="module-set$tate.html">set$$tate</a><ul class='methods'><li data-type="method" id="set$$tate-set$$tate-nav"><a href="module-set$tate.html#.set$$tate">set$$tate</a></li></ul></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#FLIPFirst">FLIPFirst</a></li><li><a href="global.html#zIndex">zIndex</a></li><li><a href="global.html#FLIPLastInvertPlay">FLIPLastInvertPlay</a></li><li><a href="global.html#commands_1">commands_1</a></li><li><a href="global.html#task$">task$</a></li><li><a href="global.html#__assign">__assign</a></li><li><a href="global.html#diff_keys">diff_keys</a></li><li><a href="global.html#stringify_type">stringify_type</a></li><li><a href="global.html#msTaskPromiseDelay">msTaskPromiseDelay</a></li><li><a href="global.html#trace$">trace$</a></li><li><a href="global.html#__read">__read</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#unparse">unparse</a></li><li><a href="global.html#xKeyError">xKeyError</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        commands/FLIP.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>"use strict";
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
var atom_1 = require("@thi.ng/atom");
var paths_1 = require("@thi.ng/paths");
var keys_js_1 = require("../keys.js");
var register_js_1 = require("./register.js");
function getRect(element, frame) {
    var _a = element.getBoundingClientRect(), top = _a.top, bottom = _a.bottom, left = _a.left, right = _a.right, width = _a.width, height = _a.height;
    var parent = frame ? frame.getBoundingClientRect() : null;
    return {
        top: top - (parent ? parent.top : 0),
        bottom: bottom,
        left: left - (parent ? parent.left : 0),
        right: right,
        width: width,
        height: height
    };
}
var S_path = "FLIP_shuffle";
var shuffle_paths = function (uid) { return ({
    rects: [S_path, "rects", uid],
    elems: [S_path, "elems", uid]
}); };
var FLIP_all = function (el, state, uid, frameDOMel) {
    if (frameDOMel === void 0) { frameDOMel = null; }
    var rects = shuffle_paths(uid).rects;
    if (!paths_1.getIn(state.deref(), rects))
        return state.resetIn(rects, getRect(el, frameDOMel));
    var F_flip_map = paths_1.getIn(state.deref(), rects);
    var L_flip_map = getRect(el, frameDOMel);
    // console.log({ F_flip_map, L_flip_map })
    var Tx = F_flip_map.left - L_flip_map.left;
    var Ty = F_flip_map.top - L_flip_map.top;
    var Sx = F_flip_map.width / L_flip_map.width;
    var Sy = F_flip_map.height / L_flip_map.height;
    el.style.transformOrigin = "0 0";
    el.style.transition = "";
    var trans = "translate(" + Tx + "px, " + Ty + "px) scale(" + Sx + ", " + Sy + ")";
    el.style.transform = trans;
    state.resetIn(rects, L_flip_map);
    requestAnimationFrame(function () {
        el.style.transition = "all .4s cubic-bezier(.54,-0.29,.17,1.11)";
        el.style.transform = "none";
    });
};
var Z_path = "FLIP_zoom";
var zoom_paths = function (uid) { return ({
    rects: [Z_path, "rects", uid],
    elems: [Z_path, "elems", uid],
    clicks: [Z_path, "clicks", uid],
    scrolls: [Z_path, "scroll", uid]
}); };
/**
 *
 * order: normalizeTree -> render -> diff -> init -> release
 *                        | hdom |         | dom | unmounted
 *
 * 1. el mounted (init): look for existing flip map for id
 *  - if exists, Play anim and store new flip map rect (for
 *    navs)
 *  - if doesn't, nada
 * 2. el clicked (render.attrs.onclick): measure and store
 *    flip map for id
 * 3. el released: if clicked, calc flip rect and lookup for
 *    id:
 *  - if first === last, no change (on nav e.g.)
 *  - if first !== last, nav change (store rect for id)
 *
 */
var FLIPFirst = function (_a) {
    // 📌 TODO: GOOD PLACE FOR AN `onStart` hook animation/callback
    var state = _a.state, id = _a.id, target = _a.target;
    var _b = zoom_paths(id), rects = _b.rects, clicks = _b.clicks, scrolls = _b.scrolls;
    // sets the rect in state for next el init to sniff
    var flip_map = getRect(target);
    state.resetIn(rects, flip_map);
    // registers component as having been clicked (focused)
    state.resetIn(clicks, true);
    state.resetIn(scrolls, { y: window.scrollY, x: window.scrollX });
};
/**
 * https://coder-coder.com/z-index-isnt-working/
 */
var zIndex = function (el, idx) { return (el.style.zIndex = idx); };
/**
 * 1. if it has been clicked that means the last thing
 *    that happened was a click that triggered this init
 *    so we do the calcs
 *
 * 2. if a back/nav (no frame) event was what triggered
 *    the init do the calcs with no frame
 *
 * What's happening:
 * - on first click (render)
 * - rect registered
 * - frame registered
 * - navs
 * - on init of new DOM
 * - checks for rect &amp; frame
 * - uses rect &amp; frame to calc diff
 * - PLAY
 *
 */
var FLIPLastInvertPlay = function (_a) {
    var element = _a.element, state = _a.state, id = _a.id, 
    // just baffle them with https://cubic-bezier.com/
    _b = _a.transition, 
    // just baffle them with https://cubic-bezier.com/
    transition = _b === void 0 ? "all .3s cubic-bezier(.54,-0.29,.17,1.11)" : _b;
    element.setAttribute("flip", id);
    var _c = zoom_paths(id), rects = _c.rects, clicks = _c.clicks, scrolls = _c.scrolls;
    var F_flip_map = paths_1.getIn(state.deref(), rects) || null;
    // NO RECT => NOT CLICKED
    if (!F_flip_map)
        return;
    // 🕛 if flip active, scroll element on init
    // element.scrollIntoView()
    /**
     * 🔥 this may cause issues for parrallel anims append this
     * to a specific target using:
     * Array.from(el.querySelectorAll("[flip]")).forEach(x=>
     * if i last... el.scrollIntoView())
     *
     */
    // 🕞 calculate location and size
    var L_flip_map = getRect(element);
    // recalc rect if out of initial view after scrolling into view
    if (Math.abs(F_flip_map.top - L_flip_map.top) > window.innerHeight) {
        element.scrollIntoView();
        L_flip_map = getRect(element);
    }
    var Tx = F_flip_map.left - L_flip_map.left;
    var Ty = F_flip_map.top - L_flip_map.top;
    var Sx = F_flip_map.width / L_flip_map.width;
    var Sy = F_flip_map.height / L_flip_map.height;
    // 🕕 just before "Last", scroll element to middle of page
    // const top = L_flip_map.top + window.pageYOffset
    var _d = paths_1.getIn(state.deref(), scrolls), x = _d.x, y = _d.y; // top - window.innerHeight / 2
    window.scrollTo(x, y);
    // console.log({ Tx, Ty, Sx, Sy })
    element.style.transformOrigin = "top left";
    element.style.transition = "";
    var trans = "translate(" + Tx + "px, " + Ty + "px) scale(" + Sx + ", " + Sy + ")";
    element.style.transform = trans;
    // PLAY
    requestAnimationFrame(function () {
        // 🕤 just before animating, scroll to new location
        window.scrollTo(x, y);
        // element.style.transformOrigin = "top left"
        element.style.transition = transition;
        element.style.transform = "none";
        // 💩 hack for removing zIndex after animation is complete
        // 📌 TODO:    🔻 GOOD PLACE FOR AN `onComplete` hook animation/callback
        setTimeout(function () { return zIndex(element, 0); }, 200);
    });
    // move element to front
    zIndex(element, 1);
    // 🔍 consider exposing in the API
    var clicked = paths_1.getIn(state.deref(), clicks) || null;
    if (!clicked) {
        // console.log(uid, "FLIP'ed on navigated")
        state.resetIn(rects, null);
    }
    else {
        // console.log(uid, "FLIP'ed on click! 👆")
        state.resetIn(rects, L_flip_map);
    }
    // remove click frame
    state.resetIn(clicks, null);
};
var state = new atom_1.Atom({});
exports.FLIP_FIRST = register_js_1.registerCMD((_a = {},
    _a[keys_js_1.CMD_SUB$] = "_FLIP_FIRST",
    _a[keys_js_1.CMD_ARGS] = function (x) { return x; },
    _a[keys_js_1.CMD_WORK] = function (_a) {
        var id = _a.id, target = _a.target;
        return FLIPFirst({ id: id, target: target, state: state });
    },
    _a));
exports.FLIP_LAST_INVERSE_PLAY = register_js_1.registerCMD((_b = {},
    _b[keys_js_1.CMD_SUB$] = "_FLIP_LAST_INVERSE_PLAY",
    _b[keys_js_1.CMD_ARGS] = function (x) { return x; },
    _b[keys_js_1.CMD_WORK] = function (_a) {
        var id = _a.id, element = _a.element;
        return FLIPLastInvertPlay({ id: id, element: element, state: state });
    },
    _b));
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
