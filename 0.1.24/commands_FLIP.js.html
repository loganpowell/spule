

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      commands/FLIP.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  
  <link type="text/css" rel="stylesheet" href="styles/collapse.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      spule documentation
    </h3>

    
      <h3>
        Resources
      </h3>
      
        <a href="http://thi.ng/umbrella">@thi.ng/umbrella</a>
      
    

    <h3>Modules</h3><ul><li id="Constants-nav"><a href="module-Constants.html">Constants</a></li><li id="Core-nav"><a href="module-Core.html">Core</a></li><li id="FLIP-nav"><a href="module-FLIP.html">FLIP</a><ul class='methods'><li data-type="method" id="FLIP-err_str-nav"><a href="module-FLIP.html#~err_str">err_str</a></li><li data-type="method" id="FLIP-FLIPFirst-nav"><a href="module-FLIP.html#~FLIPFirst">FLIPFirst</a></li><li data-type="method" id="FLIP-FLIPLastInvertPlay-nav"><a href="module-FLIP.html#~FLIPLastInvertPlay">FLIPLastInvertPlay</a></li><li data-type="method" id="FLIP-zIndex-nav"><a href="module-FLIP.html#~zIndex">zIndex</a></li></ul></li><li id="INJECT_HEAD-nav"><a href="module-INJECT_HEAD.html">INJECT_HEAD</a></li><li id="Multiplex-nav"><a href="module-Multiplex.html">Multiplex</a></li><li id="Registration-nav"><a href="module-Registration.html">Registration</a></li><li id="Routing-nav"><a href="module-Routing.html">Routing</a></li><li id="set$$tate-nav"><a href="module-set$tate.html">set$$tate</a></li><li id="SET_STATE-nav"><a href="module-SET_STATE.html">SET_STATE</a></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#diff_keys">diff_keys</a></li><li><a href="global.html#fURL">fURL</a></li><li><a href="global.html#stringify_type">stringify_type</a></li><li><a href="global.html#stringify_w_functions">stringify_w_functions</a></li><li><a href="global.html#trace$">trace$</a></li><li><a href="global.html#unfURL">unfURL</a></li><li><a href="global.html#x_key_ERR">x_key_ERR</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        commands/FLIP.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>/**
 * @module FLIP
 * @format
 */

import { Atom } from "@thi.ng/atom"
import { getIn } from "@thi.ng/paths"
import { registerCMD } from "../register/primaries"
import { sub$_, args_, handler_ } from "../store"

//
//    d8                  888
//  _d88__  e88~-_   e88~\888  e88~-_
//   888   d888   i d888  888 d888   i
//   888   8888   | 8888  888 8888   |
//   888   Y888   ' Y888  888 Y888   '
//   "88_/  "88_-~   "88_/888  "88_-~
//
//
// add before/after transition hooks for support animations

function getRect(element, frame) {
  const {
    top,
    bottom,
    left,
    right,
    width,
    height
  } = element.getBoundingClientRect()

  const parent = frame ? frame.getBoundingClientRect() : null

  return {
    top: top - (parent ? parent.top : 0),
    bottom,
    left: left - (parent ? parent.left : 0),
    right,
    width,
    height
  }
}

const shuffle_paths = uid => ({
  rects: ["_FLIP_shuffle", "rects", uid],
  elems: ["_FLIP_shuffle", "elems", uid]
})

const FLIP_all = (el, state, uid, frameDOMel = null) => {
  const { rects } = shuffle_paths(uid)

  if (!getIn(state.deref(), rects))
    return state.resetIn(rects, getRect(el, frameDOMel))

  const F_flip_map = getIn(state.deref(), rects)
  const L_flip_map = getRect(el, frameDOMel)
  // console.log({ F_flip_map, L_flip_map })

  const Tx = F_flip_map.left - L_flip_map.left
  const Ty = F_flip_map.top - L_flip_map.top
  const Sx = F_flip_map.width / L_flip_map.width
  const Sy = F_flip_map.height / L_flip_map.height

  el.style.transformOrigin = "0 0"
  el.style.transition = ""

  const trans = `translate(${Tx}px, ${Ty}px) scale(${Sx}, ${Sy})`

  el.style.transform = trans

  state.resetIn(rects, L_flip_map)

  requestAnimationFrame(() => {
    el.style.transition = "all .4s cubic-bezier(.54,-0.29,.17,1.11)"
    el.style.transform = "none"
  })
}

const zoom_paths = uid => ({
  rects: ["_FLIP_zoom", "rects", uid],
  elems: ["_FLIP_zoom", "elems", uid],
  clicks: ["_FLIP_zoom", "clicks", uid],
  scrolls: ["_FLIP_zoom", "scroll", uid]
})

/**
 *
 * order:
 * normalizeTree -> render -> diff -> init -> release
 *                 | hdom |         | dom  | post-dom
 *
 * have to think backwards:
 * 1. el mounted (init): look for existing flip map for id
 *  - if exists, Play anim and store new flip map rect (for navs)
 *  - if doesn't, nada
 * 2. el clicked (render.attrs.onclick): measure and store flip map for id
 * 3. el released: if clicked, calc flip rect and lookup for id:
 *  - if first === last, no change (on nav e.g.)
 *  - if first !== last, nav change (store rect for id)
 * @example
 * FLIPFirst({ state: "bloop"})
 *
 */
const FLIPFirst = ({ state, id, target }) => {
  // ðŸ“Œ TODO: GOOD PLACE FOR AN `onStart` hook animation/callback

  const { rects, clicks, scrolls } = zoom_paths(id)

  // sets the rect in state for next el init to sniff
  const flip_map = getRect(target)
  state.resetIn(rects, flip_map)

  // registers component as having been clicked (focused)
  state.resetIn(clicks, true)
  state.resetIn(scrolls, { y: window.scrollY, x: window.scrollX })
}

/**
 * https://coder-coder.com/z-index-isnt-working/
 */
const zIndex = (el, idx) => (el.style.zIndex = idx)

/**
 * 1. if it has been clicked that means the last thing
 *    that happened was a click that triggered this init
 *    so we do the calcs
 *
 * 2. if a back/nav (no frame) event was what triggered
 *    the init do the calcs with no frame
 */
const FLIPLastInvertPlay = ({
  element,
  state,
  id,
  // just baffle them with https://cubic-bezier.com/
  transition = "all .3s cubic-bezier(.54,-0.29,.17,1.11)"
}) => {
  element.setAttribute("flip", id)
  const { rects, clicks, scrolls } = zoom_paths(id)

  const F_flip_map = getIn(state.deref(), rects) || null
  // NO RECT => NOT CLICKED
  if (!F_flip_map) return

  // ðŸ•› if flip active, scroll element on init
  // element.scrollIntoView()
  /**
   * ðŸ”¥ this may cause issues for parrallel anims append this
   * to a specific target using:
   * Array.from(el.querySelectorAll("[flip]")).forEach(x=>
   * if i last... el.scrollIntoView())
   *
   */
  // ðŸ•ž calculate location and size
  let L_flip_map = getRect(element)

  // recalc rect if out of initial view after scrolling into view
  if (Math.abs(F_flip_map.top - L_flip_map.top) > window.innerHeight) {
    element.scrollIntoView()
    L_flip_map = getRect(element)
  }

  const Tx = F_flip_map.left - L_flip_map.left
  const Ty = F_flip_map.top - L_flip_map.top
  const Sx = F_flip_map.width / L_flip_map.width
  const Sy = F_flip_map.height / L_flip_map.height

  // ðŸ•• just before "Last", scroll element to middle of page
  // const top = L_flip_map.top + window.pageYOffset
  const { x, y } = getIn(state.deref(), scrolls) // top - window.innerHeight / 2

  window.scrollTo(x, y)

  // console.log({ Tx, Ty, Sx, Sy })

  element.style.transformOrigin = "top left"
  element.style.transition = ""
  const trans = `translate(${Tx}px, ${Ty}px) scale(${Sx}, ${Sy})`
  element.style.transform = trans

  // PLAY
  requestAnimationFrame(() => {
    // ðŸ•¤ just before animating, scroll to new location
    window.scrollTo(x, y)

    // element.style.transformOrigin = "top left"

    element.style.transition = transition
    element.style.transform = "none"
    // ðŸ’© hack for removing zIndex after animation is complete
    // ðŸ“Œ TODO:    ðŸ”» GOOD PLACE FOR AN `onComplete` hook animation/callback
    setTimeout(() => zIndex(element, 0), 200)
  })
  // move element to front
  zIndex(element, 1)
  // ðŸ” consider exposing in the API

  const clicked = getIn(state.deref(), clicks) || null

  if (!clicked) {
    // console.log(uid, "FLIP'ed on navigated")
    state.resetIn(rects, null)
  } else {
    // console.log(uid, "FLIP'ed on click! ðŸ‘†")
    state.resetIn(rects, L_flip_map)
  }

  // remove click frame
  state.resetIn(clicks, null)
}

/**
 * What's happening:
 * - on first click (render)
 *  - rect registered
 *  - frame registered
 * - navs
 * - on init of new DOM
 *  - checks for rect &amp; frame
 *  - uses rect &amp; frame to calc diff
 *  - PLAY
 */

const state = new Atom({})

export const FLIP_FIRST = registerCMD({
  [sub$_]: "FLIP_FIRST",
  [args_]: x => x,
  [handler_]: ({ id, target }) => FLIPFirst({ id, target, state })
})

export const FLIP_LAST_INVERSE_PLAY = registerCMD({
  [sub$_]: "FLIP_LAST_INVERSE_PLAY",
  [args_]: x => x,
  [handler_]: ({ id, element }) => FLIPLastInvertPlay({ id, element, state })
})
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
